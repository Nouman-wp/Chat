<script>
  const socket = io();
  const username = "<%= username %>";
  const messagesDiv = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('message-input');

  // Load old messages
  socket.on('load messages', (msgs) => {
    msgs.forEach(msg => {
      appendMessage(msg.username, msg.message, msg.timestamp, true);
    });
  });

  // Receive new message
  socket.on('chat message', (data) => {
    appendMessage(data.username, data.message, data.timestamp);
  });

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    if (input.value.trim()) {
      socket.emit('chat message', {
        username: username,
        message: input.value
      });
      input.value = '';
    }
  });

  // Append message to the chat box
  function appendMessage(sender, msg, time, isHistory = false) {
    const div = document.createElement('div');
    const formattedTime = new Date(time).toLocaleTimeString(); // Format the timestamp
    div.innerHTML = `<strong>${sender}</strong> [<small>${formattedTime}</small>]: ${msg}`;
    div.className = isHistory ? 'mb-1 text-secondary' : 'mb-1';
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
</script>
